name: Performance Benchmarks

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'JsonDdm/**'
      - 'JsonDdm.Benchmarks/**'
  workflow_dispatch:
    inputs:
      compare_to_main:
        description: 'Compare results to main branch'
        required: false
        default: true
        type: boolean

jobs:
  benchmark:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # For posting comments
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    # Run baseline benchmarks from main branch (if comparing)
    - name: Run baseline benchmarks (main branch)
      if: github.event_name == 'pull_request' || inputs.compare_to_main
      run: |
        # Save current branch
        CURRENT_BRANCH=$(git branch --show-current)
        CURRENT_SHA=${{ github.sha }}
        
        # Checkout main and run benchmarks
        git checkout main
        cd JsonDdm.Benchmarks
        dotnet run -c Release -- \
          --filter "*MergeBenchmarks*" \
          --exporters json \
          --artifacts ./baseline-results
        
        # Return to PR branch
        git checkout $CURRENT_SHA
      continue-on-error: true
    
    # Run current benchmarks
    - name: Run current benchmarks
      run: |
        cd JsonDdm.Benchmarks
        dotnet run -c Release -- \
          --filter "*MergeBenchmarks*" \
          --exporters json markdown \
          --artifacts ./current-results
    
    # Upload results as artifacts
    - name: Upload baseline results
      if: github.event_name == 'pull_request' || inputs.compare_to_main
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-baseline-${{ github.run_number }}
        path: JsonDdm.Benchmarks/baseline-results/**/*
        retention-days: 30
      continue-on-error: true
    
    - name: Upload current results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-current-${{ github.run_number }}
        path: JsonDdm.Benchmarks/current-results/**/*
        retention-days: 30
    
    # Post results as PR comment with comparison
    - name: Post benchmark results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          let comment = '## üìä Benchmark Results\n\n';
          
          try {
            const baselinePath = 'JsonDdm.Benchmarks/baseline-results';
            const currentPath = 'JsonDdm.Benchmarks/current-results';
            
            // Find JSON result files
            const findJsonFile = (dir) => {
              try {
                const files = fs.readdirSync(dir);
                return files.find(f => f.endsWith('-full-compressed.json') || f.endsWith('.json'));
              } catch (e) {
                return null;
              }
            };
            
            const baselineFile = findJsonFile(baselinePath);
            const currentFile = findJsonFile(currentPath);
            
            let baselineData = null;
            let currentData = null;
            
            if (baselineFile) {
              const content = fs.readFileSync(path.join(baselinePath, baselineFile), 'utf8');
              baselineData = JSON.parse(content);
            }
            
            if (currentFile) {
              const content = fs.readFileSync(path.join(currentPath, currentFile), 'utf8');
              currentData = JSON.parse(content);
            }
            
            if (currentData && currentData.Benchmarks) {
              // Create comparison table
              comment += '| Benchmark | Baseline | Current | Difference | Change | Status |\n';
              comment += '|-----------|----------|---------|------------|--------|--------|\n';
              
              currentData.Benchmarks.forEach(current => {
                const name = current.MethodTitle || current.Method || 'Unknown';
                const currentMean = current.Statistics?.Mean || current.Mean || 0;
                const currentUnit = 'ns';
                
                let baseline = null;
                if (baselineData && baselineData.Benchmarks) {
                  baseline = baselineData.Benchmarks.find(b => 
                    (b.MethodTitle || b.Method) === name
                  );
                }
                
                if (baseline) {
                  const baselineMean = baseline.Statistics?.Mean || baseline.Mean || 0;
                  const diff = currentMean - baselineMean;
                  const percentChange = baselineMean > 0 ? ((diff / baselineMean) * 100).toFixed(2) : 0;
                  
                  // Format numbers with proper units
                  const formatTime = (ns) => {
                    if (ns >= 1e9) return `${(ns / 1e9).toFixed(2)} s`;
                    if (ns >= 1e6) return `${(ns / 1e6).toFixed(2)} ms`;
                    if (ns >= 1e3) return `${(ns / 1e3).toFixed(2)} Œºs`;
                    return `${ns.toFixed(2)} ns`;
                  };
                  
                  const status = diff <= 0 ? '‚úÖ' : '‚ùå';
                  const diffSign = diff > 0 ? '+' : '';
                  const changeStr = `${diffSign}${percentChange}%`;
                  
                  comment += `| ${name} | ${formatTime(baselineMean)} | ${formatTime(currentMean)} | ${diffSign}${formatTime(Math.abs(diff))} | ${changeStr} | ${status} |\n`;
                } else {
                  // No baseline - just show current
                  const formatTime = (ns) => {
                    if (ns >= 1e9) return `${(ns / 1e9).toFixed(2)} s`;
                    if (ns >= 1e6) return `${(ns / 1e6).toFixed(2)} ms`;
                    if (ns >= 1e3) return `${(ns / 1e3).toFixed(2)} Œºs`;
                    return `${ns.toFixed(2)} ns`;
                  };
                  
                  comment += `| ${name} | N/A | ${formatTime(currentMean)} | N/A | N/A | üÜï |\n`;
                }
              });
              
              // Add legend
              comment += '\n### Legend\n\n';
              comment += '- **Benchmark**: Name of the benchmark test\n';
              comment += '- **Baseline**: Performance on `main` branch (mean execution time)\n';
              comment += '- **Current**: Performance of current PR (mean execution time)\n';
              comment += '- **Difference**: Absolute time difference (Current - Baseline)\n';
              comment += '- **Change**: Percentage change from baseline\n';
              comment += '- **Status**: ‚úÖ Improved (faster) | ‚ùå Regressed (slower) | üÜï New benchmark\n';
              comment += '\nüí° _Lower execution time is better_\n';
              
            } else {
              comment += 'Benchmark completed but could not parse results. View artifacts for detailed results.\n';
            }
            
          } catch (error) {
            comment += `‚ö†Ô∏è Could not process benchmark results: ${error.message}\n\n`;
            comment += '```\n' + error.stack + '\n```\n';
          }
          
          comment += '\n---\n';
          comment += `Run ID: ${context.runId} | Commit: ${context.sha.substring(0, 7)}`;
          
          // Post comment
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
      continue-on-error: true
    
    # Fail if performance regressed significantly (optional)
    - name: Check for performance regression
      if: github.event_name == 'pull_request'
      run: |
        echo "Performance regression check would go here"
        echo "You can implement custom logic to compare JSON results"
        echo "and fail the build if metrics degraded beyond threshold"
      continue-on-error: true

  # Full benchmark suite (manual trigger only)
  full-benchmark:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Run all benchmarks
      run: |
        cd JsonDdm.Benchmarks
        dotnet run -c Release -- \
          --exporters json html csv markdown \
          --artifacts ./full-results
    
    - name: Upload full results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-full-${{ github.run_number }}
        path: JsonDdm.Benchmarks/full-results/**/*
        retention-days: 90
